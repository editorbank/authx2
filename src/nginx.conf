env HELLO_NAME;
load_module modules/ngx_http_js_module.so;

user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    js_import http.js;
    include       /etc/nginx/mime.types;

    map_hash_bucket_size 164;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    upstream app-upstream {
        server localhost:8031;
    }

    upstream sppp-upstream {
        server localhost:8011;
    }
 
    server {
        listen       80;
        listen  [::]:80;
        server_name  localhost;

        #access_log  /var/log/nginx/host.access.log  main;

        root   /usr/share/nginx/html;
        index  index.html index.htm;
        default_type text/html;

        location = /session1 {
            set $cook "SESSION=session1; Max-Age=120; Path=/";
            add_header Set-Cookie $cook;
            return 200 'Set-Cookie "$cook"';
        }
        location = /session2 {
            set $cook "SESSION=session7e58d63b602b5ccfa245607c; Max-Age=120; Path=/";
            add_header Set-Cookie $cook;
            return 200 'Set-Cookie "$cook"';
        }
        location = /session-off {
            set $cook "SESSION=; Max-Age=0";
            add_header Set-Cookie $cook;
            return 200 'Set-Cookie "$cook"';
        }
        location = /favicon.ico {
            return 200 '';
        }
        location = / {
        }
        location = /index.html {
        }
        location = /login.html {
        }

        location = /auth {
            proxy_pass_request_body off;
            proxy_set_header Content-Length '';
            proxy_set_header iv-uri $origin_uri;
            proxy_set_header iv-method $origin_method;
#            proxy_set_header iv-user $http_iv_user;
            proxy_set_header iv-session $iv_session;
            proxy_pass 'http://sppp-upstream$origin_uri';
        }

        location @on403 {
            default_type  "text/html";
            return 200 '
                <html>
                    <head>
                        <meta http-equiv="refresh" content="0; url=/login.html?msg=403" />
                    </head>
                </html>
            ';
        }

        location /closed-content {
            set $origin_uri $uri;
            set $origin_method $request_method;
            set $iv_session $cookie_session;
            auth_request /auth;
            proxy_pass 'http://app-upstream$origin_uri';
            error_page 403 @on403;
            # proxy_set_header iv-session $iv_session;
            # proxy_cookie_path /closed-content "/; SESSION=None; HTTPOnly; Secure";
            # proxy_cookie_path /foo "/; SameSite=None; HTTPOnly; Secure";
            # proxy_cookie_path / "/; HTTPOnly; Secure";
            # proxy_set_header cookie "SESSION=AAAAA";
        }      
        location = /login/check {
            # proxy_pass 'http://localhost:8031';
            proxy_pass 'http://localhost:8041';
        }      
    }

    ### модуль проверки соответствия логина и пароля и уcтановка куки сесии

    map $query_string $ses {
        default: "";
        include *.login-session;
        "username=24c9e15e52afc47c225b757e7bee1f9d&password=769b288bff0716a022e526fc600f9e61" "session1";
        "username=user1&password=pass1" "session1";
        "username=7e58d63b60197ceb55a1c487989a3720&password=bf8e2361c37c65dc842b5ccfa245607c" "session7e58d63b602b5ccfa245607c";
    }
    server {
        listen       8041;
        if ($ses = "") {
            return 403 'DENY';
        }
        add_header Set-Cookie "SESSION=$ses; Max-Age=600; Path=/";
        default_type  "text/html";
        return 200 '<h1>Successful login!</h1><a href="/">Continue...</a>';
    }


    ### модуль проверки прав пользователя (User Rights Verification Module)

    map "$http_iv_session|$http_iv_method|$uri" $ask {
        default: 0;
        include *.right;
        "session1|GET|/favicon.ico" 1;
        "session1|GET|/closed-content" 1;
        "session1|GET|/closed-content/" 1;
        "session1|GET|/closed-content/index.html" 1;
        "~^session7e58d63b602b5ccfa245607c" 1;
    }
    server {
        listen       8011;
        if ($ask = 1) {
          return 200 'OK';
        }
        return 403 'DENY';
    }


    ### Симулятор приложения (Application Simulator) 

    server {
        listen       8031;
        default_type  "text/html";
        add_header DEBUG-Application "8031";
        return 200 '
            <table BORDER=1>
            <tablehead>Nginx variables<tablehead>
            <tablebody>
                <tr><th>document_root</th>        <td>$document_root</td></tr>
                <tr><th>query_string</th>         <td>$query_string</td></tr>
                <tr><th>request_method</th>       <td>$request_method</td></tr>
                <tr><th>request_uri</th>          <td>$request_uri</td></tr>
                <tr><th>http_iv_user</th>         <td>$http_iv_user</td></tr>
                <tr><th>http_iv_host</th>         <td>$http_iv_host</td></tr>
                <tr><th>http_iv_session</th>      <td>$http_iv_session</td></tr>
                <tr><th>cookie_session</th>      <td>$cookie_session</td></tr>
                
            </tablebody>
            </table>
            <table BORDER=1>
            <tablehead>Apache variables<tablehead>
            <tablebody>
                <tr><th>args</th>      <td>$args</td></tr>
                <tr><th>arg_name</th>  <td>$arg_name</td></tr>
                <tr><th>host</th>      <td>$host</td></tr>
                <tr><th>uri</th>       <td>$uri</td></tr>
                <tr><th>msec</th>      <td>$msec</td></tr>
                <tr><th>request</th>       <td>$request</td></tr>
                <tr><th>request_id</th>    <td>$request_id</td></tr>
                <tr><th>request_body</th>  <td>$request_body</td></tr>

                <tr><th>time_iso8601</th>  <td>$time_iso8601</td></tr>
                <tr><th>time_local</th>  <td>$time_local</td></tr>
                
            </tablebody>
            </table>
        ';
    }

}
