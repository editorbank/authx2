
user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;

    map_hash_bucket_size 164;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    upstream application-upstream {
        server 127.0.0.1:8031;
    }

    upstream authorization-upstream {
        server 127.0.0.1:8011;
    }
 
    upstream authentication-upstream {
        server 127.0.0.1:8041;
    }
 
    server {
        listen 0.0.0.0:80; # слушается и заглушка и внешний интерфейс

        root /usr/share/nginx/html;
        index index.html index.htm;
        default_type text/html;

        location = /favicon.ico {}
        location = / {}
        location = /index.html {}
        location = /login.html {}

        location = /logout {
            add_header Set-Cookie "SESSION=; Max-Age=0";
            try_files /public/logout.html =404;
        }
        location = /login/check {
            proxy_pass 'http://authentication-upstream';
        }      

        location = /authorization_request {
            proxy_pass_request_body off;
            proxy_set_header Content-Length '';
            proxy_set_header iv-uri $origin_uri;
            proxy_set_header iv-method $origin_method;
            proxy_set_header iv-session $iv_session;
            proxy_pass 'http://authorization-upstream$origin_uri';
        }

        location /secret {
            set $origin_uri $uri;
            set $origin_method $request_method;
            set $iv_session $cookie_session;
            auth_request /authorization_request;
            auth_request_set $iv_user $upstream_http_iv_user;
            proxy_set_header iv-user $iv_user;
            proxy_pass 'http://application-upstream$origin_uri';
            error_page 401 /public/needlogin.html;
        }      
    }

    ### authentication - модуль проверки соответствия логина и пароля и уcтановка куки сесии

    map $query_string $ses {
        default: "";
        include *.a1;
    }
    server {
        listen 127.0.0.1:8041; # слушается только заглушка (loopback)
        default_type  "text/html";
        root /usr/share/nginx/html;
        error_page 406 = @406;
        if ($ses = "") {
            return 406 ;
        }
        add_header Set-Cookie "SESSION=$ses; Max-Age=600; Path=/";
        try_files /public/successful.html =404;

        location @406 {
            try_files /public/failed.html =404;
        }
    }


    ### authorization - модуль проверки прав пользователя (User Rights Verification Module)

    map "$http_iv_session;$http_iv_method;$uri" $ask {
        default: 0;
        include *.a2;
    }
    map "$http_iv_session" $user {
        default: "";
        include *.user;
    }
    server {
        listen  127.0.0.1:8011; # слушается только заглушка (loopback)
        if ($ask != 1) {
           return 401;
        }
        add_header iv-user $user;
        return 200;
    }


    ### Симулятор приложения (Application Simulator) 

    server {
        listen 127.0.0.1:8031;
        default_type  "text/html";
        add_header DEBUG-Application "8031";
        return 200 '
            <table BORDER=1>
            <tablehead>Nginx variables<tablehead>
            <tablebody>
                <tr><th>document_root</th>        <td>$document_root</td></tr>
                <tr><th>query_string</th>         <td>$query_string</td></tr>
                <tr><th>request_method</th>       <td>$request_method</td></tr>
                <tr><th>request_uri</th>          <td>$request_uri</td></tr>
                <tr><th>http_iv_user</th>         <td>$http_iv_user</td></tr>
                <tr><th>http_iv_host</th>         <td>$http_iv_host</td></tr>
                <tr><th>http_iv_session</th>      <td>$http_iv_session</td></tr>
                <tr><th>cookie_session</th>      <td>$cookie_session</td></tr>
                
            </tablebody>
            </table>
            <table BORDER=1>
            <tablehead>Apache variables<tablehead>
            <tablebody>
                <tr><th>args</th>      <td>$args</td></tr>
                <tr><th>arg_name</th>  <td>$arg_name</td></tr>
                <tr><th>host</th>      <td>$host</td></tr>
                <tr><th>uri</th>       <td>$uri</td></tr>
                <tr><th>msec</th>      <td>$msec</td></tr>
                <tr><th>request</th>       <td>$request</td></tr>
                <tr><th>request_id</th>    <td>$request_id</td></tr>
                <tr><th>request_body</th>  <td>$request_body</td></tr>

                <tr><th>time_iso8601</th>  <td>$time_iso8601</td></tr>
                <tr><th>time_local</th>  <td>$time_local</td></tr>
                
            </tablebody>
            </table>
        ';
    }
}
