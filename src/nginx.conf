env HELLO_NAME;
load_module modules/ngx_http_js_module.so;

user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    js_import http.js;
    include       /etc/nginx/mime.types;

    map_hash_bucket_size 64;


    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    upstream app-upstream {
        server localhost:8031;
    }

    upstream sppp-upstream {
        server localhost:8011;
    }
 
    server {
        listen       80;
        listen  [::]:80;
        server_name  localhost;

        #access_log  /var/log/nginx/host.access.log  main;

        root   /usr/share/nginx/html;
        index  index.html index.htm;
        default_type text/html;

        location = /session1 {
            add_header Set-Cookie "SESSION=session1; Max-Age=60; Path=/";
            return 200 'Hello from ${hostname}!';
        }
        location = /session2 {
            add_header Set-Cookie "SESSION=session2; Max-Age=60; Path=/";
            return 200 'Hello from ${hostname}!';
        }
        location = /session-off {
            add_header Set-Cookie "SESSION=; Max-Age=0";
            return 200 'Hello from ${hostname}!';
        }
        location = /favicon.ico {
            return 200 '';
        }
        location = / {
        }
        location = /index.html {
        }
        location = /login.html {
        }

        location /closed-content/ {
            auth_request /auth;
            error_page 401 /login.html;
        }

        location = /auth {
            proxy_pass_request_body off;
            proxy_set_header Content-Length '';
            proxy_set_header iv-uri $origin_uri;
            proxy_set_header iv-method $origin_method;
#            proxy_set_header iv-user $http_iv_user;
            proxy_set_header iv-session $iv_session;
            proxy_pass 'http://sppp-upstream$origin_uri';
        }

        location ~ /.+ {
            set $origin_uri $uri;
            set $origin_method $request_method;
            set $iv_session $cookie_session;
            auth_request /auth;
            proxy_pass 'http://app-upstream$origin_uri';
            # proxy_set_header iv-session $iv_session;
            # proxy_cookie_path /closed-content "/; SESSION=None; HTTPOnly; Secure";
            # proxy_cookie_path /foo "/; SameSite=None; HTTPOnly; Secure";
            # proxy_cookie_path / "/; HTTPOnly; Secure";
            # proxy_set_header cookie "SESSION=AAAAA";
        }
    }



    # ### Add iv-user by cookie session


    # server {
    #     listen       9001;

    #     location = /auth {
    #         proxy_pass_request_body off;
    #         proxy_set_header Content-Length '';
    #         proxy_set_header iv-session $iv_session;
    #         proxy_pass 'http://localhost:9101';
    #     }

    #     location / {
    #         set $iv_session $cookie_session;
    #         auth_request /auth;
    #         proxy_set_header iv-user $send_http_iv_user;
    #         proxy_pass 'http://localhost:9002';
    #     }
    # }
    # map "$http_iv_session" $iv_user {
    # default: '';
    # include *.session-user;
    # "" "user1";  #TODO
    # "session1" "user1";  #TODO
    # }
    # server {
    #     listen       9101;

    #     if ($iv_user != '') {
    #       add_header iv-user $iv_user;
    #       return 200 'OK';
    #     }
    #     return 403 'DENY';
    # }

    # ### Add iv-group by header iv-user

    # server {
    #     listen       9002;

    #     location = /auth {
    #         proxy_pass_request_body off;
    #         proxy_set_header Content-Length '';
    #         proxy_set_header iv-session $cookie_session;
    #         proxy_pass 'http://localhost:9202';
    #     }

    #     location / {
    #         auth_request /auth;
    #         proxy_set_header iv-group $send_http_iv_group;
    #         proxy_pass 'http://localhost:9003';
    #     }
    # }
    # map "$http_iv_user" $iv_group {
    # default: '';
    # include *.user-group;
    # "user1" "group1";  #TODO
    # }
    # server {
    #     listen       9202;

    #     if ($iv_user != '') {
    #       add_header iv-group $iv_group;
    #       return 200 'OK';
    #     }
    #     return 403 'DENY';
    # }

 

    ### модуль проверки прав пользователя (User Rights Verification Module)

    map "$http_iv_session|$http_iv_method|$uri" $ask {
    default: 0;
    include *.right;
    # "|GET|/favicon.ico" 1;
    # "|GET|/closed-content" 1;
    # "|GET|/closed-content/" 1;
    # "|GET|/closed-content/index.html" 1;
    "session1|GET|/favicon.ico" 1;
    "session1|GET|/closed-content" 1;
    "session1|GET|/closed-content/" 1;
    "session1|GET|/closed-content/index.html" 1;
    }
    server {
        listen       8011;

        if ($ask = 1) {
          return 200 'OK';
        }
        return 403 'DENY';
    }



    ### Симулятор приложения (Application Simulator) 

    server {
        listen       8031;

        location / {
            return 200 '
                <table BORDER=1>
                <tablehead>Nginx variables<tablehead>
                <tablebody>
                    <tr><th>document_root</th>        <td>$document_root</td></tr>
                    <tr><th>query_string</th>         <td>$query_string</td></tr>
                    <tr><th>request_method</th>       <td>$request_method</td></tr>
                    <tr><th>request_uri</th>          <td>$request_uri</td></tr>
                    <tr><th>http_iv_user</th>         <td>$http_iv_user</td></tr>
                    <tr><th>http_iv_host</th>         <td>$http_iv_host</td></tr>
                    <tr><th>http_iv_session</th>      <td>$http_iv_session</td></tr>
                    <tr><th>cookie_session</th>      <td>$cookie_session</td></tr>
                    
                </tablebody>
                </table>
                <table BORDER=1>
                <tablehead>Apache variables<tablehead>
                <tablebody>
                    <tr><th>args</th>      <td>$args</td></tr>
                    <tr><th>arg_name</th>  <td>$arg_name</td></tr>
                    <tr><th>host</th>      <td>$host</td></tr>
                    <tr><th>uri</th>       <td>$uri</td></tr>
                    <tr><th>msec</th>      <td>$msec</td></tr>
                    <tr><th>request</th>       <td>$request</td></tr>
                    <tr><th>request_id</th>    <td>$request_id</td></tr>
                    <tr><th>request_body</th>  <td>$request_body</td></tr>

                    <tr><th>time_iso8601</th>  <td>$time_iso8601</td></tr>
                    <tr><th>time_local</th>  <td>$time_local</td></tr>
                    
                </tablebody>
                </table>
            ';
        }
    }

}
